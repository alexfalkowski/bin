#!/usr/bin/env bash
# shellcheck disable=SC2086 disable=SC2155

set -eo pipefail

readonly message=$(git log --pretty=format:"%s" -n 1)

if [[ "$message" =~ ^chore* ]]; then
  readonly name="$1"
  readonly platform="$2"
  readonly latest_tag="$(git tag | sort -V | tail -1)"
  readonly dir="$(dirname "$(readlink -f "$0")")"

  # Create an multi arch builder.
  docker buildx create --name go-multi-builder --driver docker-container

  # Build and push docker.
  docker build --builder go-multi-builder --platform $platform --build-arg name=$name --build-arg version=$latest_tag -t alexfalkowski/$name -t alexfalkowski/$name:$latest_tag -f $dir/go/Dockerfile --push .
fi
